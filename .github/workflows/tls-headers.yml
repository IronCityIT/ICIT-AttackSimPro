name: AttackSimPro - TLS & Headers Evidence

# ============================================================
# TLS & HEADERS SCAN - Collect SSL/TLS config and security headers
# Evidence collection for compliance and security posture
# Triggered via CLI only - no manual runs without parameters
# ============================================================

on:
  workflow_dispatch:
    inputs:
      target_url:
        description: 'Target URL to scan (e.g., https://example.com)'
        required: true
      scan_id:
        description: 'Unique scan identifier from CLI'
        required: true
      client_id:
        description: 'Client identifier for reporting'
        required: false
        default: 'internal'

permissions:
  contents: read

# Only allow one scan at a time per client
concurrency:
  group: tls-headers-${{ github.event.inputs.client_id }}
  cancel-in-progress: false

jobs:
  tls_headers:
    name: TLS & Security Headers Check
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Validate inputs
        run: |
          if [ -z "${{ github.event.inputs.target_url }}" ]; then
            echo "âŒ ERROR: target_url is required"
            exit 1
          fi
          if [ -z "${{ github.event.inputs.scan_id }}" ]; then
            echo "âŒ ERROR: scan_id is required"
            exit 1
          fi
          
          # Basic URL validation - must be HTTPS for TLS checks
          TARGET="${{ github.event.inputs.target_url }}"
          if [[ ! "$TARGET" =~ ^https:// ]]; then
            echo "âš ï¸ WARNING: Target should be https:// for TLS analysis"
            echo "   Proceeding anyway, but TLS checks may fail for http://"
          fi
          
          echo "âœ… Inputs validated"
          echo "   Target: $TARGET"
          echo "   Scan ID: ${{ github.event.inputs.scan_id }}"
          echo "   Client: ${{ github.event.inputs.client_id }}"

      - name: Install dependencies
        run: |
          sudo apt-get update -y
          sudo apt-get install -y jq openssl curl

      - name: Create output directory
        run: |
          mkdir -p tls-reports
          chmod 777 tls-reports

      - name: Purple Team Notification - Scan Starting
        run: |
          echo "ğŸ” =============================================="
          echo "ğŸ” TLS & SECURITY HEADERS CHECK STARTING"
          echo "ğŸ” =============================================="
          echo ""
          echo "ğŸ“‹ Scan Details:"
          echo "   Type: TLS/SSL & Headers Evidence Collection"
          echo "   Target: ${{ github.event.inputs.target_url }}"
          echo "   Scan ID: ${{ github.event.inputs.scan_id }}"
          echo "   Client: ${{ github.event.inputs.client_id }}"
          echo "   Timestamp: $(date -u '+%Y-%m-%d %H:%M:%S UTC')"
          echo ""

      - name: Extract host from URL
        id: extract_host
        run: |
          TARGET="${{ github.event.inputs.target_url }}"
          HOST=$(echo "$TARGET" | sed -E 's#https?://##' | sed -E 's#/.*##' | sed -E 's#:.*##')
          PORT=$(echo "$TARGET" | grep -oE ':[0-9]+' | tr -d ':' || echo "443")
          
          if [ -z "$PORT" ]; then
            if [[ "$TARGET" =~ ^https:// ]]; then
              PORT="443"
            else
              PORT="80"
            fi
          fi
          
          echo "host=$HOST" >> $GITHUB_OUTPUT
          echo "port=$PORT" >> $GITHUB_OUTPUT
          echo "Extracted host: $HOST:$PORT"

      - name: Collect TLS/SSL Certificate Info
        id: tls_check
        run: |
          HOST="${{ steps.extract_host.outputs.host }}"
          PORT="${{ steps.extract_host.outputs.port }}"
          SCAN_ID="${{ github.event.inputs.scan_id }}"
          
          echo "Checking TLS for $HOST:$PORT..."
          
          # Initialize results
          TLS_ISSUES=0
          
          # Get certificate details
          echo | openssl s_client -connect "$HOST:$PORT" -servername "$HOST" 2>/dev/null | \
            openssl x509 -noout -text > "tls-reports/cert-$SCAN_ID.txt" 2>/dev/null || true
          
          # Get certificate chain
          echo | openssl s_client -connect "$HOST:$PORT" -servername "$HOST" -showcerts 2>/dev/null > "tls-reports/chain-$SCAN_ID.txt" || true
          
          # Check certificate expiry
          EXPIRY=$(echo | openssl s_client -connect "$HOST:$PORT" -servername "$HOST" 2>/dev/null | \
            openssl x509 -noout -enddate 2>/dev/null | cut -d= -f2 || echo "Unknown")
          
          # Check days until expiry
          if [ "$EXPIRY" != "Unknown" ]; then
            EXPIRY_EPOCH=$(date -d "$EXPIRY" +%s 2>/dev/null || echo "0")
            NOW_EPOCH=$(date +%s)
            DAYS_LEFT=$(( (EXPIRY_EPOCH - NOW_EPOCH) / 86400 ))
            
            if [ "$DAYS_LEFT" -lt 30 ]; then
              echo "âš ï¸ Certificate expires in $DAYS_LEFT days!"
              TLS_ISSUES=$((TLS_ISSUES + 1))
            fi
          else
            DAYS_LEFT="Unknown"
          fi
          
          # Check TLS versions supported
          echo "Checking supported TLS versions..."
          TLS_VERSIONS=""
          
          for VERSION in tls1 tls1_1 tls1_2 tls1_3; do
            if echo | openssl s_client -connect "$HOST:$PORT" -servername "$HOST" -$VERSION 2>/dev/null | grep -q "Cipher"; then
              TLS_VERSIONS="$TLS_VERSIONS $VERSION"
              if [ "$VERSION" = "tls1" ] || [ "$VERSION" = "tls1_1" ]; then
                echo "âš ï¸ Deprecated TLS version supported: $VERSION"
                TLS_ISSUES=$((TLS_ISSUES + 1))
              fi
            fi
          done
          
          # Get cipher suites
          echo | openssl s_client -connect "$HOST:$PORT" -servername "$HOST" 2>/dev/null | \
            grep -E "Cipher|Protocol" > "tls-reports/cipher-$SCAN_ID.txt" || true
          
          echo "tls_issues=$TLS_ISSUES" >> $GITHUB_OUTPUT
          echo "expiry=$EXPIRY" >> $GITHUB_OUTPUT
          echo "days_left=$DAYS_LEFT" >> $GITHUB_OUTPUT
          echo "tls_versions=$TLS_VERSIONS" >> $GITHUB_OUTPUT
          
          echo ""
          echo "ğŸ“œ Certificate Expiry: $EXPIRY ($DAYS_LEFT days)"
          echo "ğŸ”’ TLS Versions: $TLS_VERSIONS"

      - name: Collect Security Headers
        id: headers_check
        run: |
          TARGET="${{ github.event.inputs.target_url }}"
          SCAN_ID="${{ github.event.inputs.scan_id }}"
          
          echo "Collecting security headers from $TARGET..."
          
          # Get all response headers
          curl -sI -L --max-time 30 "$TARGET" > "tls-reports/headers-$SCAN_ID.txt" 2>/dev/null || true
          
          # Initialize counters
          HEADERS_PRESENT=0
          HEADERS_MISSING=0
          HEADER_ISSUES=""
          
          # Check for security headers
          declare -A SECURITY_HEADERS=(
            ["Strict-Transport-Security"]="HSTS - Enforces HTTPS"
            ["Content-Security-Policy"]="CSP - Prevents XSS"
            ["X-Frame-Options"]="Clickjacking protection"
            ["X-Content-Type-Options"]="MIME sniffing protection"
            ["X-XSS-Protection"]="XSS filter (legacy)"
            ["Referrer-Policy"]="Controls referrer info"
            ["Permissions-Policy"]="Browser feature permissions"
          )
          
          echo ""
          echo "ğŸ” Security Headers Analysis:"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          
          for HEADER in "${!SECURITY_HEADERS[@]}"; do
            if grep -qi "^$HEADER:" "tls-reports/headers-$SCAN_ID.txt" 2>/dev/null; then
              VALUE=$(grep -i "^$HEADER:" "tls-reports/headers-$SCAN_ID.txt" | head -1)
              echo "âœ… $HEADER: Present"
              HEADERS_PRESENT=$((HEADERS_PRESENT + 1))
            else
              echo "âŒ $HEADER: Missing - ${SECURITY_HEADERS[$HEADER]}"
              HEADERS_MISSING=$((HEADERS_MISSING + 1))
              HEADER_ISSUES="$HEADER_ISSUES$HEADER,"
            fi
          done
          
          echo ""
          echo "headers_present=$HEADERS_PRESENT" >> $GITHUB_OUTPUT
          echo "headers_missing=$HEADERS_MISSING" >> $GITHUB_OUTPUT
          echo "missing_headers=$HEADER_ISSUES" >> $GITHUB_OUTPUT

      - name: Generate JSON report
        run: |
          SCAN_ID="${{ github.event.inputs.scan_id }}"
          
          cat > "tls-reports/report-$SCAN_ID.json" << EOF
          {
            "scan_id": "${{ github.event.inputs.scan_id }}",
            "scan_type": "tls-headers",
            "target": "${{ github.event.inputs.target_url }}",
            "client_id": "${{ github.event.inputs.client_id }}",
            "timestamp": "$(date -u '+%Y-%m-%dT%H:%M:%SZ')",
            "tls": {
              "certificate_expiry": "${{ steps.tls_check.outputs.expiry }}",
              "days_until_expiry": "${{ steps.tls_check.outputs.days_left }}",
              "tls_versions": "${{ steps.tls_check.outputs.tls_versions }}",
              "issues_found": ${{ steps.tls_check.outputs.tls_issues }}
            },
            "headers": {
              "present": ${{ steps.headers_check.outputs.headers_present }},
              "missing": ${{ steps.headers_check.outputs.headers_missing }},
              "missing_headers": "${{ steps.headers_check.outputs.missing_headers }}"
            },
            "summary": {
              "tls_issues": ${{ steps.tls_check.outputs.tls_issues }},
              "header_issues": ${{ steps.headers_check.outputs.headers_missing }},
              "total_issues": $(( ${{ steps.tls_check.outputs.tls_issues }} + ${{ steps.headers_check.outputs.headers_missing }} ))
            }
          }
          EOF
          
          echo "âœ… JSON report generated"
          cat "tls-reports/report-$SCAN_ID.json"

      - name: Generate HTML report
        run: |
          SCAN_ID="${{ github.event.inputs.scan_id }}"
          
          cat > "tls-reports/report-$SCAN_ID.html" << 'HTMLEOF'
          <!DOCTYPE html>
          <html>
          <head>
            <title>AttackSimPro - TLS & Headers Report</title>
            <style>
              body { font-family: Arial, sans-serif; margin: 20px; background: #1a1a2e; color: #eee; }
              h1, h2 { color: #9d4edd; }
              .summary { display: flex; gap: 20px; margin: 20px 0; }
              .stat { padding: 15px 25px; border-radius: 8px; text-align: center; }
              .good { background: #2d6a4f; }
              .warning { background: #f77f00; }
              .bad { background: #c1121f; }
              .section { background: #16213e; padding: 15px; margin: 15px 0; border-radius: 8px; }
              .header-item { padding: 8px; margin: 5px 0; border-radius: 4px; }
              .present { background: #2d6a4f; }
              .missing { background: #c1121f; }
              pre { background: #0f0f23; padding: 10px; border-radius: 4px; overflow-x: auto; font-size: 12px; }
            </style>
          </head>
          <body>
          HTMLEOF
          
          cat >> "tls-reports/report-$SCAN_ID.html" << EOF
            <h1>ğŸ” AttackSimPro - TLS & Headers Report</h1>
            <p><strong>Target:</strong> ${{ github.event.inputs.target_url }}</p>
            <p><strong>Scan ID:</strong> ${{ github.event.inputs.scan_id }}</p>
            <p><strong>Client:</strong> ${{ github.event.inputs.client_id }}</p>
            <p><strong>Timestamp:</strong> $(date -u '+%Y-%m-%d %H:%M:%S UTC')</p>
            
            <div class="summary">
              <div class="stat $([ ${{ steps.tls_check.outputs.tls_issues }} -eq 0 ] && echo 'good' || echo 'warning')">
                <strong>${{ steps.tls_check.outputs.tls_issues }}</strong><br>TLS Issues
              </div>
              <div class="stat $([ ${{ steps.headers_check.outputs.headers_missing }} -le 2 ] && echo 'good' || echo 'warning')">
                <strong>${{ steps.headers_check.outputs.headers_missing }}</strong><br>Missing Headers
              </div>
              <div class="stat good">
                <strong>${{ steps.headers_check.outputs.headers_present }}</strong><br>Headers Present
              </div>
            </div>
            
            <div class="section">
              <h2>ğŸ”’ TLS/SSL Analysis</h2>
              <p><strong>Certificate Expiry:</strong> ${{ steps.tls_check.outputs.expiry }}</p>
              <p><strong>Days Until Expiry:</strong> ${{ steps.tls_check.outputs.days_left }}</p>
              <p><strong>TLS Versions:</strong> ${{ steps.tls_check.outputs.tls_versions }}</p>
            </div>
            
            <div class="section">
              <h2>ğŸ›¡ï¸ Security Headers</h2>
          EOF
          
          # Add header status
          for HEADER in "Strict-Transport-Security" "Content-Security-Policy" "X-Frame-Options" "X-Content-Type-Options" "X-XSS-Protection" "Referrer-Policy" "Permissions-Policy"; do
            if grep -qi "^$HEADER:" "tls-reports/headers-$SCAN_ID.txt" 2>/dev/null; then
              echo "<div class='header-item present'>âœ… $HEADER</div>" >> "tls-reports/report-$SCAN_ID.html"
            else
              echo "<div class='header-item missing'>âŒ $HEADER - Missing</div>" >> "tls-reports/report-$SCAN_ID.html"
            fi
          done
          
          cat >> "tls-reports/report-$SCAN_ID.html" << 'HTMLEOF'
            </div>
            
            <div class="section">
              <h2>ğŸ“„ Raw Headers</h2>
              <pre id="raw-headers"></pre>
            </div>
            
          </body>
          </html>
          HTMLEOF
          
          # Append raw headers
          sed -i "s|<pre id=\"raw-headers\"></pre>|<pre>$(cat "tls-reports/headers-$SCAN_ID.txt" 2>/dev/null | sed 's/&/\&amp;/g; s/</\&lt;/g; s/>/\&gt;/g' || echo 'No headers collected')</pre>|" "tls-reports/report-$SCAN_ID.html" || true
          
          echo "âœ… HTML report generated"

      - name: Summary
        id: summary
        run: |
          echo ""
          echo "ğŸ” =============================================="
          echo "ğŸ” TLS & HEADERS CHECK RESULTS"
          echo "ğŸ” =============================================="
          echo ""
          echo "ğŸ“‹ TLS/SSL:"
          echo "   Certificate Expiry: ${{ steps.tls_check.outputs.expiry }}"
          echo "   Days Until Expiry: ${{ steps.tls_check.outputs.days_left }}"
          echo "   TLS Issues: ${{ steps.tls_check.outputs.tls_issues }}"
          echo ""
          echo "ğŸ“‹ Security Headers:"
          echo "   Present: ${{ steps.headers_check.outputs.headers_present }}"
          echo "   Missing: ${{ steps.headers_check.outputs.headers_missing }}"
          echo ""
          
          TOTAL_ISSUES=$(( ${{ steps.tls_check.outputs.tls_issues }} + ${{ steps.headers_check.outputs.headers_missing }} ))
          if [ "$TOTAL_ISSUES" -eq 0 ]; then
            echo "âœ… Excellent! No issues found."
          elif [ "$TOTAL_ISSUES" -le 3 ]; then
            echo "âš ï¸ Minor issues found. Review recommended."
          else
            echo "ğŸ”´ Multiple issues found. Action required."
          fi

      - name: Upload scan artifacts
        uses: actions/upload-artifact@v4
        with:
          name: tls-headers-${{ github.event.inputs.scan_id }}
          path: tls-reports/
          retention-days: 90

      - name: Purple Team Notification - Scan Complete
        run: |
          echo ""
          echo "ğŸ” =============================================="
          echo "ğŸ” TLS & HEADERS CHECK COMPLETE"
          echo "ğŸ” =============================================="
          echo ""
          echo "ğŸ“‹ Summary:"
          echo "   Scan ID: ${{ github.event.inputs.scan_id }}"
          echo "   Target: ${{ github.event.inputs.target_url }}"
          echo "   Client: ${{ github.event.inputs.client_id }}"
          echo "   Completed: $(date -u '+%Y-%m-%d %H:%M:%S UTC')"
          echo ""
          echo "ğŸ“ Reports available in workflow artifacts"
          echo ""

