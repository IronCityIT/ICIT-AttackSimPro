name: AttackSimPro - TLS & Headers Evidence

on:
  schedule:
    - cron: "15 2 * * *" # Daily 02:15 UTC
  workflow_dispatch:

permissions:
  contents: read

jobs:
  tls_headers:
    name: ğŸŸ£ TLS & Security Headers Check
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
      
      - name: Validate targets list
        run: |
          set -euo pipefail
          test -f manifests/targets.txt
          sed -i '/^\s*$/d' manifests/targets.txt
          echo "Targets:"
          cat manifests/targets.txt
      
      - name: ğŸŸ£ Purple Team - Scan Starting
        run: |
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "ğŸŸ£ AttackSimPro - TLS & Headers Check"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "Targets: $(wc -l < manifests/targets.txt)"
          echo "Time: $(date -u '+%Y-%m-%d %H:%M:%S UTC')"
      
      - name: Collect TLS and headers
        run: |
          set -euo pipefail
          sudo apt-get update -y
          sudo apt-get install -y jq openssl curl
          TS="$(date -u +'%Y-%m-%dT%H-%M-%SZ')"
          mkdir -p out/tls-headers
          
          # Array to collect all evidence
          echo "[]" > out/tls-headers/all-evidence.json
          
          while IFS= read -r url; do
            url="$(echo "$url" | xargs)"
            [ -z "$url" ] && continue
            
            host="$(echo "$url" | sed -E 's#https?://##' | cut -d/ -f1)"
            safe_host="$(echo "$host" | tr ':' '_' )"
            
            # Get TLS cert info
            CERT_DATES="$(echo | openssl s_client -servername "$host" -connect "$host:443" 2>/dev/null | openssl x509 -noout -dates || true)"
            NOT_BEFORE="$(echo "$CERT_DATES" | grep -i notBefore | cut -d= -f2- | sed 's/^[[:space:]]*//')"
            NOT_AFTER="$(echo "$CERT_DATES" | grep -i notAfter  | cut -d= -f2- | sed 's/^[[:space:]]*//')"
            
            # Get HTTP headers
            HDRS="out/tls-headers/headers_${safe_host}_${TS}.txt"
            curl -sS -D "$HDRS" -o /dev/null "$url" || true
            
            get_hdr () { grep -i "^$1:" "$HDRS" | head -n 1 | sed -E "s/^$1:[[:space:]]*//I" || true; }
            
            # Create evidence JSON
            EVIDENCE=$(jq -n \
              --arg ts "$TS" \
              --arg url "$url" \
              --arg host "$host" \
              --arg not_before "$NOT_BEFORE" \
              --arg not_after "$NOT_AFTER" \
              --arg hsts "$(get_hdr 'Strict-Transport-Security')" \
              --arg csp "$(get_hdr 'Content-Security-Policy')" \
              --arg xfo "$(get_hdr 'X-Frame-Options')" \
              --arg xcto "$(get_hdr 'X-Content-Type-Options')" \
              --arg rp "$(get_hdr 'Referrer-Policy')" \
              --arg pp "$(get_hdr 'Permissions-Policy')" \
              '{
                timestamp_utc: $ts,
                url: $url,
                host: $host,
                tls: { not_before: $not_before, not_after: $not_after },
                headers: {
                  strict_transport_security: $hsts,
                  content_security_policy: $csp,
                  x_frame_options: $xfo,
                  x_content_type_options: $xcto,
                  referrer_policy: $rp,
                  permissions_policy: $pp
                }
              }')
            
            # Save individual evidence
            echo "$EVIDENCE" > "out/tls-headers/evidence_${safe_host}_${TS}.json"
            
            # Append to all-evidence array
            jq --argjson item "$EVIDENCE" '. += [$item]' out/tls-headers/all-evidence.json > out/tls-headers/all-evidence.tmp.json
            mv out/tls-headers/all-evidence.tmp.json out/tls-headers/all-evidence.json
            
          done < manifests/targets.txt
          
          # Create manifest
          jq -n \
            --arg ts "$TS" \
            --arg job "TLS & Headers Evidence" \
            --arg targets "$(paste -sd "," manifests/targets.txt)" \
            '{
              product: "ICIT AttackSimPro",
              job: $job,
              timestamp_utc: $ts,
              targets_csv: $targets
            }' > out/tls-headers/manifest.json
          
          # Create Cloud Function payload
          jq -n \
            --arg ts "$TS" \
            --argjson evidence "$(cat out/tls-headers/all-evidence.json)" \
            '{
              scan_type: "tls_headers",
              timestamp: $ts,
              evidence: $evidence
            }' > out/tls-headers/cloud-payload.json
      
      - name: ğŸš€ Upload to AttackSimPro Dashboard
        if: always()
        run: |
          if [ -f "out/tls-headers/cloud-payload.json" ]; then
            RESPONSE=$(curl -s -w "\n%{http_code}" -X POST \
              -H "Content-Type: application/json" \
              -d @out/tls-headers/cloud-payload.json \
              "https://storescanresults-wrl6y3keaa-ul.a.run.app")
            
            HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
            BODY=$(echo "$RESPONSE" | sed '$d')
            
            if [ "$HTTP_CODE" = "200" ]; then
              echo "âœ… Results uploaded to AttackSimPro Dashboard"
              echo "$BODY" | jq '.' || echo "$BODY"
            else
              echo "âš ï¸  Upload failed (HTTP $HTTP_CODE)"
              echo "$BODY"
            fi
          fi
      
      - name: Package evidence
        run: |
          TS="$(date -u +'%Y-%m-%dT%H-%M-%SZ')"
          zip -r "attacksimpro_tls_headers_${TS}.zip" out/tls-headers manifests/targets.txt
      
      - name: Upload evidence artifact
        uses: actions/upload-artifact@v4
        with:
          name: attacksimpro-tls-headers
          path: attacksimpro_tls_headers_*.zip
      
      - name: ğŸŸ£ Scan Complete
        if: always()
        run: |
          TARGETS=$(jq 'length' out/tls-headers/all-evidence.json || echo "0")
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "âœ… TLS & Headers Check Complete"
          echo "Targets Scanned: $TARGETS"
          echo "Dashboard: https://ironcity-attacksimpro.web.app"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
