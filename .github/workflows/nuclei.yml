name: AttackSimPro - Nuclei Scan

# ============================================================
# NUCLEI SCAN - Fast vulnerability scanner using templates
# Scans for CVEs, misconfigurations, exposed panels, etc.
# Triggered via CLI only - no manual runs without parameters
# ============================================================

on:
  workflow_dispatch:
    inputs:
      target_url:
        description: 'Target URL or IP to scan (e.g., https://example.com or http://192.168.1.100)'
        required: true
      scan_id:
        description: 'Unique scan identifier from CLI'
        required: true
      client_id:
        description: 'Client identifier for reporting'
        required: false
        default: 'internal'
      severity:
        description: 'Minimum severity to report (info, low, medium, high, critical)'
        required: false
        default: 'medium,high,critical'
      template_tags:
        description: 'Template tags to include (e.g., cve,exposure,misconfig)'
        required: false
        default: ''

permissions:
  contents: read

# Only allow one scan at a time per client
concurrency:
  group: nuclei-${{ github.event.inputs.client_id }}
  cancel-in-progress: false

jobs:
  nuclei_scan:
    name: Nuclei Vulnerability Scan
    runs-on: ubuntu-latest
    timeout-minutes: 60

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Validate inputs
        run: |
          if [ -z "${{ github.event.inputs.target_url }}" ]; then
            echo "‚ùå ERROR: target_url is required"
            exit 1
          fi
          if [ -z "${{ github.event.inputs.scan_id }}" ]; then
            echo "‚ùå ERROR: scan_id is required"
            exit 1
          fi
          
          # Basic URL validation
          TARGET="${{ github.event.inputs.target_url }}"
          if [[ ! "$TARGET" =~ ^https?:// ]]; then
            echo "‚ùå ERROR: target_url must start with http:// or https://"
            exit 1
          fi
          
          echo "‚úÖ Inputs validated"
          echo "   Target: $TARGET"
          echo "   Scan ID: ${{ github.event.inputs.scan_id }}"
          echo "   Client: ${{ github.event.inputs.client_id }}"
          echo "   Severity: ${{ github.event.inputs.severity }}"

      - name: Purple Team Notification - Scan Starting
        run: |
          echo "üü¢ =============================================="
          echo "üü¢ NUCLEI VULNERABILITY SCAN STARTING"
          echo "üü¢ =============================================="
          echo ""
          echo "üìã Scan Details:"
          echo "   Type: Nuclei Template Scan"
          echo "   Target: ${{ github.event.inputs.target_url }}"
          echo "   Scan ID: ${{ github.event.inputs.scan_id }}"
          echo "   Client: ${{ github.event.inputs.client_id }}"
          echo "   Severity Filter: ${{ github.event.inputs.severity }}"
          echo "   Timestamp: $(date -u '+%Y-%m-%d %H:%M:%S UTC')"
          echo ""
          echo "üìä Nuclei scans for CVEs, misconfigs, exposed panels, and more."
          echo ""

      - name: Install Nuclei
        run: |
          set -euo pipefail
          echo "Installing Nuclei..."
          
          # Get latest release
          curl -s https://api.github.com/repos/projectdiscovery/nuclei/releases/latest | \
            grep browser_download_url | grep linux_amd64.zip | cut -d '"' -f 4 | \
            xargs -I{} curl -L -o nuclei.zip {}
          
          unzip -o nuclei.zip
          sudo mv nuclei /usr/local/bin/nuclei
          nuclei -version

      - name: Update Nuclei templates
        run: |
          set -euo pipefail
          echo "Updating Nuclei templates..."
          nuclei -update-templates
          echo "‚úÖ Templates updated"

      - name: Create output directory
        run: |
          mkdir -p nuclei-reports
          chmod 777 nuclei-reports

      - name: Run Nuclei Scan
        id: nuclei_scan
        run: |
          set -euo pipefail
          echo "Starting Nuclei scan against ${{ github.event.inputs.target_url }}"
          
          # Build command with optional tags
          NUCLEI_CMD="nuclei -u ${{ github.event.inputs.target_url }} -severity ${{ github.event.inputs.severity }} -jsonl -o nuclei-reports/nuclei-${{ github.event.inputs.scan_id }}.jsonl"
          
          # Add template tags if specified
          if [ -n "${{ github.event.inputs.template_tags }}" ]; then
            NUCLEI_CMD="$NUCLEI_CMD -tags ${{ github.event.inputs.template_tags }}"
          fi
          
          echo "Running: $NUCLEI_CMD"
          eval $NUCLEI_CMD || true
          
          # Also generate markdown report
          nuclei -u ${{ github.event.inputs.target_url }} \
            -severity ${{ github.event.inputs.severity }} \
            -markdown-export nuclei-reports/markdown-${{ github.event.inputs.scan_id }} || true

      - name: Parse and summarize results
        id: parse
        run: |
          set -euo pipefail
          sudo apt-get install -y jq
          
          JSONL_FILE="nuclei-reports/nuclei-${{ github.event.inputs.scan_id }}.jsonl"
          
          if [ -f "$JSONL_FILE" ] && [ -s "$JSONL_FILE" ]; then
            # Count by severity
            CRITICAL=$(grep -c '"severity":"critical"' "$JSONL_FILE" 2>/dev/null || echo "0")
            HIGH=$(grep -c '"severity":"high"' "$JSONL_FILE" 2>/dev/null || echo "0")
            MEDIUM=$(grep -c '"severity":"medium"' "$JSONL_FILE" 2>/dev/null || echo "0")
            LOW=$(grep -c '"severity":"low"' "$JSONL_FILE" 2>/dev/null || echo "0")
            INFO=$(grep -c '"severity":"info"' "$JSONL_FILE" 2>/dev/null || echo "0")
            TOTAL=$(wc -l < "$JSONL_FILE")
            
            echo "critical=$CRITICAL" >> $GITHUB_OUTPUT
            echo "high=$HIGH" >> $GITHUB_OUTPUT
            echo "medium=$MEDIUM" >> $GITHUB_OUTPUT
            echo "low=$LOW" >> $GITHUB_OUTPUT
            echo "info=$INFO" >> $GITHUB_OUTPUT
            echo "total=$TOTAL" >> $GITHUB_OUTPUT
            
            echo ""
            echo "üü¢ =============================================="
            echo "üü¢ NUCLEI SCAN RESULTS SUMMARY"
            echo "üü¢ =============================================="
            echo "  üíÄ Critical:  $CRITICAL"
            echo "  üî¥ High:      $HIGH"
            echo "  üü† Medium:    $MEDIUM"
            echo "  üü° Low:       $LOW"
            echo "  ‚ÑπÔ∏è  Info:      $INFO"
            echo "  ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
            echo "  üìä Total:     $TOTAL"
            echo ""
            
            # Show top findings
            echo "üìã Top Findings:"
            jq -r 'select(.severity == "critical" or .severity == "high") | "  - [\(.severity | ascii_upcase)] \(.info.name // .template-id)"' "$JSONL_FILE" 2>/dev/null | head -10 || echo "  No critical/high findings"
            
          else
            echo "‚úÖ No vulnerabilities found (or scan produced no output)"
            echo "critical=0" >> $GITHUB_OUTPUT
            echo "high=0" >> $GITHUB_OUTPUT
            echo "medium=0" >> $GITHUB_OUTPUT
            echo "low=0" >> $GITHUB_OUTPUT
            echo "info=0" >> $GITHUB_OUTPUT
            echo "total=0" >> $GITHUB_OUTPUT
          fi

      - name: Generate HTML report
        run: |
          JSONL_FILE="nuclei-reports/nuclei-${{ github.event.inputs.scan_id }}.jsonl"
          HTML_FILE="nuclei-reports/nuclei-${{ github.event.inputs.scan_id }}.html"
          
          cat > "$HTML_FILE" << 'HTMLHEAD'
          <!DOCTYPE html>
          <html>
          <head>
            <title>AttackSimPro - Nuclei Scan Report</title>
            <style>
              body { font-family: Arial, sans-serif; margin: 20px; background: #1a1a2e; color: #eee; }
              h1 { color: #9d4edd; }
              .summary { display: flex; gap: 20px; margin: 20px 0; }
              .stat { padding: 15px 25px; border-radius: 8px; text-align: center; }
              .critical { background: #7b2cbf; }
              .high { background: #c1121f; }
              .medium { background: #f77f00; }
              .low { background: #fcbf49; color: #333; }
              .info { background: #4361ee; }
              .finding { background: #16213e; padding: 15px; margin: 10px 0; border-radius: 8px; border-left: 4px solid #9d4edd; }
              .finding h3 { margin: 0 0 10px 0; }
              .severity { padding: 3px 8px; border-radius: 4px; font-size: 12px; }
              pre { background: #0f0f23; padding: 10px; border-radius: 4px; overflow-x: auto; }
            </style>
          </head>
          <body>
            <h1>üü¢ AttackSimPro - Nuclei Scan Report</h1>
          HTMLHEAD
          
          echo "<p><strong>Target:</strong> ${{ github.event.inputs.target_url }}</p>" >> "$HTML_FILE"
          echo "<p><strong>Scan ID:</strong> ${{ github.event.inputs.scan_id }}</p>" >> "$HTML_FILE"
          echo "<p><strong>Client:</strong> ${{ github.event.inputs.client_id }}</p>" >> "$HTML_FILE"
          echo "<p><strong>Timestamp:</strong> $(date -u '+%Y-%m-%d %H:%M:%S UTC')</p>" >> "$HTML_FILE"
          
          echo "<div class='summary'>" >> "$HTML_FILE"
          echo "<div class='stat critical'><strong>${{ steps.parse.outputs.critical }}</strong><br>Critical</div>" >> "$HTML_FILE"
          echo "<div class='stat high'><strong>${{ steps.parse.outputs.high }}</strong><br>High</div>" >> "$HTML_FILE"
          echo "<div class='stat medium'><strong>${{ steps.parse.outputs.medium }}</strong><br>Medium</div>" >> "$HTML_FILE"
          echo "<div class='stat low'><strong>${{ steps.parse.outputs.low }}</strong><br>Low</div>" >> "$HTML_FILE"
          echo "<div class='stat info'><strong>${{ steps.parse.outputs.info }}</strong><br>Info</div>" >> "$HTML_FILE"
          echo "</div>" >> "$HTML_FILE"
          
          echo "<h2>Findings</h2>" >> "$HTML_FILE"
          
          if [ -f "$JSONL_FILE" ] && [ -s "$JSONL_FILE" ]; then
            while IFS= read -r line; do
              NAME=$(echo "$line" | jq -r '.info.name // .template-id // "Unknown"')
              SEVERITY=$(echo "$line" | jq -r '.severity // "unknown"')
              MATCHED=$(echo "$line" | jq -r '.matched-at // .host // "N/A"')
              DESC=$(echo "$line" | jq -r '.info.description // "No description"' | head -c 500)
              
              echo "<div class='finding'>" >> "$HTML_FILE"
              echo "<h3>$NAME <span class='severity $SEVERITY'>$SEVERITY</span></h3>" >> "$HTML_FILE"
              echo "<p><strong>Matched:</strong> $MATCHED</p>" >> "$HTML_FILE"
              echo "<p>$DESC</p>" >> "$HTML_FILE"
              echo "</div>" >> "$HTML_FILE"
            done < "$JSONL_FILE"
          else
            echo "<p>No vulnerabilities found.</p>" >> "$HTML_FILE"
          fi
          
          echo "</body></html>" >> "$HTML_FILE"
          echo "‚úÖ HTML report generated"

      - name: Upload scan artifacts
        uses: actions/upload-artifact@v4
        with:
          name: nuclei-${{ github.event.inputs.scan_id }}
          path: nuclei-reports/
          retention-days: 90

      - name: Purple Team Notification - Scan Complete
        run: |
          echo ""
          echo "üü¢ =============================================="
          echo "üü¢ NUCLEI SCAN COMPLETE"
          echo "üü¢ =============================================="
          echo ""
          echo "üìã Summary:"
          echo "   Scan ID: ${{ github.event.inputs.scan_id }}"
          echo "   Target: ${{ github.event.inputs.target_url }}"
          echo "   Client: ${{ github.event.inputs.client_id }}"
          echo "   Completed: $(date -u '+%Y-%m-%d %H:%M:%S UTC')"
          echo ""
          echo "üìÅ Reports available in workflow artifacts"
          echo ""

      # Optional: Post results to your backend
      # - name: Post results to AttackSimPro API
      #   if: ${{ secrets.ATTACKSIMPRO_API_URL }}
      #   run: |
      #     curl -X POST "${{ secrets.ATTACKSIMPRO_API_URL }}/api/scans/complete" \
      #       -H "Authorization: Bearer ${{ secrets.ATTACKSIMPRO_API_KEY }}" \
      #       -H "Content-Type: application/json" \
      #       -d '{
      #         "scan_id": "${{ github.event.inputs.scan_id }}",
      #         "scan_type": "nuclei",
      #         "target": "${{ github.event.inputs.target_url }}",
      #         "client_id": "${{ github.event.inputs.client_id }}",
      #         "critical": ${{ steps.parse.outputs.critical }},
      #         "high": ${{ steps.parse.outputs.high }},
      #         "medium": ${{ steps.parse.outputs.medium }},
      #         "low": ${{ steps.parse.outputs.low }},
      #         "info": ${{ steps.parse.outputs.info }}
      #       }'
