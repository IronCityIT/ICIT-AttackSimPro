name: AttackSimPro - ZAP Baseline (Passive)

on:
  schedule:
    - cron: "0 3 * * 1" # Mondays 03:00 UTC
  workflow_dispatch:

permissions:
  contents: read

jobs:
  zap_baseline:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Validate targets list
        run: |
          set -euo pipefail
          test -f manifests/targets.txt
          sed -i '/^\s*$/d' manifests/targets.txt
          echo "Targets:"
          cat manifests/targets.txt

      - name: Run ZAP Baseline (per target)
        run: |
          set -euo pipefail
          TS="$(date -u +'%Y-%m-%dT%H-%M-%SZ')"
          mkdir -p out/zap

          i=0
          while IFS= read -r url; do
            url="$(echo "$url" | xargs)"
            [ -z "$url" ] && continue
            i=$((i+1))

            echo "ZAP baseline scanning: $url"
            docker run --rm -t ghcr.io/zaproxy/zaproxy:stable zap-baseline.py \
              -t "$url" \
              -a \
              -J "zap_target${i}_${TS}.json" \
              -r "zap_target${i}_${TS}.html"

            mv "zap_target${i}_${TS}.json" "out/zap/"
            mv "zap_target${i}_${TS}.html" "out/zap/"
          done < manifests/targets.txt

      - name: Write manifest
        run: |
          set -euo pipefail
          sudo apt-get update -y
          sudo apt-get install -y jq
          TS="$(date -u +'%Y-%m-%dT%H-%M-%SZ')"
          jq -n \
            --arg ts "$TS" \
            --arg job "ZAP Baseline (Passive)" \
            --arg targets "$(paste -sd "," manifests/targets.txt)" \
            '{
              product: "ICIT AttackSimPro",
              job: $job,
              timestamp_utc: $ts,
              targets_csv: $targets
            }' > out/zap/manifest.json

      - name: Package evidence
        run: |
          set -euo pipefail
          TS="$(date -u +'%Y-%m-%dT%H-%M-%SZ')"
          zip -r "attacksimpro_zap_${TS}.zip" out/zap manifests/targets.txt

      - name: Upload evidence artifact
        uses: actions/upload-artifact@v4
        with:
          name: attacksimpro-zap
          path: attacksimpro_zap_*.zip
