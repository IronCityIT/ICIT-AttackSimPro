name: AttackSimPro - ZAP Baseline (Purple Team)

on:
  schedule:
    - cron: '0 2 * * 1'  # Weekly Monday 2am
  workflow_dispatch:
    inputs:
      target_url:
        description: 'Target URL to scan'
        required: false
        default: 'https://www.ironcityit.com'

concurrency:
  group: zap-baseline-scan
  cancel-in-progress: false

jobs:
  zap_baseline:
    name: ğŸŸ£ ZAP Baseline Scan
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Set target URL
        id: target
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ] && [ -n "${{ github.event.inputs.target_url }}" ]; then
            echo "url=${{ github.event.inputs.target_url }}" >> $GITHUB_OUTPUT
          else
            echo "url=https://www.ironcityit.com" >> $GITHUB_OUTPUT
          fi
      
      - name: Create working directory
        run: |
          mkdir -p zap-reports
          chmod 777 zap-reports
      
      - name: ğŸŸ£ Purple Team - Scan Starting
        run: |
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "ğŸŸ£ AttackSimPro - ZAP Baseline Scan"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "Target: ${{ steps.target.outputs.url }}"
          echo "Time: $(date -u '+%Y-%m-%d %H:%M:%S UTC')"
      
      - name: Run ZAP Baseline Scan
        run: |
          docker run -v $(pwd)/zap-reports:/zap/wrk/:rw \
            -t ghcr.io/zaproxy/zaproxy:stable \
            zap-baseline.py \
            -t ${{ steps.target.outputs.url }} \
            -r zap-report.html \
            -J zap-report.json \
            -I || true
      
      - name: Parse Results
        id: parse
        run: |
          if [ -f "zap-reports/zap-report.json" ]; then
            HIGH=$(jq '[.site[].alerts[] | select(.riskdesc | startswith("High"))] | length' zap-reports/zap-report.json || echo "0")
            MEDIUM=$(jq '[.site[].alerts[] | select(.riskdesc | startswith("Medium"))] | length' zap-reports/zap-report.json || echo "0")
            LOW=$(jq '[.site[].alerts[] | select(.riskdesc | startswith("Low"))] | length' zap-reports/zap-report.json || echo "0")
            INFO=$(jq '[.site[].alerts[] | select(.riskdesc | startswith("Informational"))] | length' zap-reports/zap-report.json || echo "0")
            
            echo "high=$HIGH" >> $GITHUB_OUTPUT
            echo "medium=$MEDIUM" >> $GITHUB_OUTPUT
            echo "low=$LOW" >> $GITHUB_OUTPUT
            echo "info=$INFO" >> $GITHUB_OUTPUT
          fi
      
      - name: ğŸš€ Upload to AttackSimPro Dashboard
        if: always()
        run: |
          if [ -f "zap-reports/zap-report.json" ]; then
            # Add scan_type to the JSON
            jq '. + {scan_type: "zap"}' zap-reports/zap-report.json > zap-report-tagged.json
            
            RESPONSE=$(curl -s -w "\n%{http_code}" -X POST \
              -H "Content-Type: application/json" \
              -d @zap-report-tagged.json \
              "https://storescanresults-wrl6y3keaa-ul.a.run.app")
            
            HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
            BODY=$(echo "$RESPONSE" | sed '$d')
            
            if [ "$HTTP_CODE" = "200" ]; then
              echo "âœ… Results uploaded to AttackSimPro Dashboard"
              echo "$BODY" | jq '.' || echo "$BODY"
            else
              echo "âš ï¸  Upload failed (HTTP $HTTP_CODE)"
              echo "$BODY"
            fi
          fi
      
      - name: Upload Artifacts
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: zap-scan-results-${{ github.run_number }}
          path: |
            zap-reports/zap-report.html
            zap-reports/zap-report.json
          retention-days: 90
      
      - name: ğŸŸ£ Scan Complete
        if: always()
        run: |
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "âœ… ZAP Scan Complete"
          echo "High: ${{ steps.parse.outputs.high || 'N/A' }}"
          echo "Medium: ${{ steps.parse.outputs.medium || 'N/A' }}"
          echo "Low: ${{ steps.parse.outputs.low || 'N/A' }}"
          echo "Info: ${{ steps.parse.outputs.info || 'N/A' }}"
          echo "Dashboard: https://ironcity-attacksimpro.web.app"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
