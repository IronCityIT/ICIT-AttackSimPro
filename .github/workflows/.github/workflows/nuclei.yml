name: AttackSimPro - Nuclei Scan

on:
  schedule:
    - cron: "30 3 * * 3"   # Wednesdays 03:30 UTC
  workflow_dispatch:

permissions:
  contents: read

jobs:
  nuclei:
    runs-on: ubuntu-latest
    steps:
      - name: Run Nuclei against targets
        uses: projectdiscovery/nuclei-action@v2
        with:
          target: |
            ${{ vars.SCAN_TARGET_1 }}
            ${{ vars.SCAN_TARGET_2 }}
          args: |
            -severity ${{ vars.NUCLEI_SEVERITIES }}
            -jsonl
            -o nuclei.jsonl

      - name: Package Evidence
        run: |
          set -euo pipefail
          TS="$(date -u +'%Y-%m-%dT%H-%M-%SZ')"
          mkdir -p evidence
          mv nuclei.jsonl evidence/
          cat > evidence/manifest.json << EOF
          {
            "product": "ICIT AttackSimPro",
            "job": "Nuclei Scan",
            "timestamp_utc": "${TS}",
            "targets": [
              "${{ vars.SCAN_TARGET_1 }}",
              "${{ vars.SCAN_TARGET_2 }}"
            ],
            "severities": "${{ vars.NUCLEI_SEVERITIES }}"
          }
          EOF
          zip -r "attacksimpro_nuclei_${TS}.zip" evidence

      - name: Upload Artifact to GitHub
        uses: actions/upload-artifact@v4
        with:
          name: attacksimpro-nuclei-evidence
          path: attacksimpro_nuclei_*.zip
